<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>ElmCropper</title>
	<base href="/">
	<link rel="stylesheet" href="/dist/css/style.css">
</head>
<body>
<script src="/dist/js/app.js"></script>
<script>
	if (window.location.pathname.indexOf("sandbox") > -1) {
		Elm.Sandbox.fullscreen();
	} else {
		var app = Elm.Main.fullscreen();

		var params = window.location.search.substring(1)
						.split("&")
						.reduce(function(a, v) {
							var s = v.split("=");
							a[s[0]] = s[1];
							return a;
						}, {}) || {};

		if (params.s && params.w && params.h) {
			app.ports.cropperWithImage.send({
				url: params.s,
				width: parseInt(params.w, 10),
				height: parseInt(params.h, 10)
			});
		}

		app.ports.imageCropped.subscribe(function(data) {
			console.log('image', data);
			var url = data.cropperModel.image.imageUrl;
			var originX = 0;
			var originY = 0;

			var outputWidth = data.cropperModel.image.crop.width;
			var outputHeight = data.cropperModel.image.crop.height;


			var canvas = document.createElement('canvas');
			canvas.width = outputWidth;
			canvas.height = outputHeight;

			var context = canvas.getContext('2d');
			var imageObj = new Image();
			imageObj.src = url;

			context.drawImage(
					imageObj,
					originX,
					originY,
					outputWidth,
					outputHeight,
					0,
					0,
					outputWidth,
					outputHeight
			);


			var dataURL = canvas.toDataURL();
			window.open(dataURL);
		});

		window.app = app;

	}
</script>
</body>
</html>
