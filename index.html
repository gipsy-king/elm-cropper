<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Elm Image Crop</title>
	<base href="/">
	<link rel="stylesheet" href="/dist/css/style.css">
</head>
<body>
<script src="/dist/js/app.js"></script>
<script>
	if (window.location.pathname.indexOf("sandbox") > -1) {
		Elm.Sandbox.fullscreen();
	} else {
		var app = Elm.Main.fullscreen();

		var params = window.location.search.substring(1)
						.split("&")
						.reduce(function(a, v) {
							var s = v.split("=");
							a[s[0]] = s[1];
							return a;
						}, {}) || {};

		if (params.s && params.w && params.h) {
			app.ports.cropperWithImage.send({
				url: params.s,
				width: parseInt(params.w, 10),
				height: parseInt(params.h, 10)
			});
		}

		app.ports.imageCropped.subscribe(function(data) {
			var url = data.url;
			var size = data.size;
			var resized = data.resized;
			var origin = data.origin;
			var crop = data.crop;

			var canvas = document.createElement('canvas');
			canvas.width = crop.width;
			canvas.height = crop.height;
			var context = canvas.getContext('2d');

			var imageObj = new Image();
			imageObj.src = url;
			imageObj.onload = function() {
				context.drawImage(
						imageObj,
						0,
						0,
						size.width,
						size.height,
						-origin.x,
						-origin.y,
						resized.width,
						resized.height
				);

				var dataURL = canvas.toDataURL("image/jpeg", 1.0);
				window.open(dataURL);
			};
		});
	}
</script>
</body>
</html>
